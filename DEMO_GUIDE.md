# 🎯 Демонстрация системы логина и регистрации

## 📱 User Interface Flow

### 1. Главная страница (начальное состояние)
```
┌─────────────────────────────────────────────────────────────┐
│  A.R.E.S.  |  О Проекте | Функции | Цены      [RU/KZ/EN] 👤 Войти │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│     A.R.E.S. — Автономная ПОДДЕРЖКА 24/7                   │
│     Получить своего Чат-бота  |  Демо Чат-бота             │
│                                                               │
│     Доступен бесплатный план                                │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 2. Нажимаем "Войти" → открывается модаль логина
```
┌─────────────────────────────────────────────────────────────┐
│         ┌─────────────────────────────────────┐              │
│         │  Вход в Аккаунт                  ✕  │              │
│         │  ═════════════════════════════════  │              │
│         │                                      │              │
│         │  Email:                              │              │
│         │  [___________________________]        │              │
│         │                                      │              │
│         │  Пароль:                             │              │
│         │  [___________________________]        │              │
│         │                                      │              │
│         │  [Войти]                             │              │
│         │                                      │              │
│         │  Нет аккаунта? Зарегистрироваться   │              │
│         └─────────────────────────────────────┘              │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 3. Переходим на регистрацию (нажали ссылку)
```
┌─────────────────────────────────────────────────────────────┐
│         ┌─────────────────────────────────────┐              │
│         │  Регистрация                      ✕  │              │
│         │  ═════════════════════════════════  │              │
│         │                                      │              │
│         │  Имя компании:                       │              │
│         │  [___________________________]        │              │
│         │                                      │              │
│         │  Email:                              │              │
│         │  [___________________________]        │              │
│         │                                      │              │
│         │  Пароль:                             │              │
│         │  [___________________________]        │              │
│         │                                      │              │
│         │  Повторите пароль:                  │              │
│         │  [___________________________]        │              │
│         │                                      │              │
│         │  [Зарегистрироваться]                │              │
│         │                                      │              │
│         │  Уже есть аккаунт? Войти            │              │
│         └─────────────────────────────────────┘              │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 4. После успешной регистрации
```
┌─────────────────────────────────────────────────────────────┐
│  A.R.E.S.  |  О Проекте | Функции | Цены      [RU/KZ/EN] 👤 My Company │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│     ✅ Регистрация успешна!                                 │
│     Модаль закрывается...                                    │
│                                                               │
│     Кнопка "Войти" теперь показывает имя пользователя      │
│     и имеет зеленый цвет                                    │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 5. Нажимаем на имя пользователя (👤 My Company) → логаут
```
┌─────────────────────────────────────────────────────────────┐
│  A.R.E.S.  |  О Проекте | Функции | Цены      [RU/KZ/EN] 👤 Войти │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│     ✅ Вы вышли из системы                                  │
│                                                               │
│     Кнопка вернулась к "Войти"                              │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 6. Кнопка администратора (верхний правый угол)
```
┌─────────────────────────────────────────────────────────────┐
│  A.R.E.S.  |  О Проекте | Функции | Цены      [RU/KZ/EN] 👤 Admin │
└─────────────────────────────────────────────────────────────┘
     ↑
     └── Нажимаем → открывается модаль регистрации админа
```

### 7. Модаль регистрации администратора
```
┌─────────────────────────────────────────────────────────────┐
│         ┌─────────────────────────────────────┐              │
│         │ Регистрация администратора       ✕  │              │
│         │ ═════════════════════════════════  │              │
│         │                                      │              │
│         │ Имя пользователя:                    │              │
│         │ [___________________________]        │              │
│         │                                      │              │
│         │ Email:                               │              │
│         │ [___________________________]        │              │
│         │                                      │              │
│         │ Пароль:                              │              │
│         │ [___________________________]        │              │
│         │                                      │              │
│         │ Подтверждение пароля:               │              │
│         │ [___________________________]        │              │
│         │                                      │              │
│         │ [✅ Зарегистрировать]                │              │
│         │                                      │              │
│         │ ✅ Администратор успешно            │              │
│         │    зарегистрирован!                │              │
│         └─────────────────────────────────────┘              │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔗 API Endpoints Flow

### Регистрация пользователя
```
Frontend: Форма регистрации
    ↓
POST /api/auth/register
    ↓
Backend проверяет:
  ✓ Email уникален
  ✓ Username уникален
  ✓ Пароль >= 6 символов
    ↓
Backend действует:
  1. Хеширует пароль (bcrypt)
  2. Сохраняет в БД таблицу users
  3. Создает JWT токен
    ↓
Ответ:
{
  "success": true,
  "data": {
    "access_token": "eyJ0eXAi...",
    "user": { ... }
  }
}
    ↓
Frontend:
  1. Сохраняет токен в localStorage
  2. Сохраняет данные пользователя
  3. Обновляет кнопку "Войти"
  4. Закрывает модаль
```

### Логин пользователя
```
Frontend: Форма логина
    ↓
POST /api/auth/login
    ↓
Backend проверяет:
  ✓ Email существует в БД
  ✓ Пароль соответствует (bcrypt)
    ↓
Backend действует:
  1. Создает JWT токен
  2. Возвращает данные пользователя
    ↓
Ответ:
{
  "success": true,
  "data": {
    "access_token": "eyJ0eXAi...",
    "user": { ... }
  }
}
    ↓
Frontend:
  1. Сохраняет токен в localStorage
  2. Обновляет UI
```

### Получить профиль
```
Frontend отправляет:
GET /api/auth/me
Authorization: Bearer eyJ0eXAi...
    ↓
Backend:
  1. Проверяет токен
  2. Достает user_id из токена
  3. Возвращает данные пользователя
    ↓
Ответ: UserResponse с полной информацией
```

---

## 💾 Данные в localStorage

После логина/регистрации:

```javascript
localStorage.access_token
→ "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOjEsImV4cCI6..."

localStorage.user
→ {
    "id": 1,
    "username": "mycompany",
    "email": "user@example.com",
    "company_name": "My Company",
    "is_admin": false,
    "is_active": true,
    "created_at": "2025-12-06T10:00:00"
  }
```

---

## 🗄️ Структура БД

### Таблица users

```
┌──────────────────────────────────────────────────────┐
│ users                                                │
├──────────────────────────────────────────────────────┤
│ id              INTEGER  PK  AUTO INCREMENT          │
│ username        VARCHAR  UNIQUE NOT NULL             │
│ email           VARCHAR  UNIQUE NOT NULL             │
│ hashed_password VARCHAR  NOT NULL                    │
│ company_name    VARCHAR                              │
│ is_admin        BOOLEAN  DEFAULT FALSE               │
│ is_active       BOOLEAN  DEFAULT TRUE                │
│ created_at      DATETIME DEFAULT CURRENT_TIMESTAMP   │
│ updated_at      DATETIME DEFAULT CURRENT_TIMESTAMP   │
└──────────────────────────────────────────────────────┘

Примеры записей:

id | username  | email               | is_admin | is_active
──────────────────────────────────────────────────────────────
1  | mycompany | user@example.com    | 0        | 1
2  | admin_usr | admin@example.com   | 1        | 1
3  | company2  | user2@example.com   | 0        | 1
```

---

## 🔒 JWT Токен структура

### Header
```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

### Payload
```json
{
  "sub": 1,           // user_id
  "exp": 1733541234  // expiration time (30 минут)
}
```

### Signature
```
HMACSHA256(
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  SECRET_KEY
)
```

### Полный токен
```
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.
eyJzdWIiOjEsImV4cCI6MTczMzU0MTIzNH0.
4qZeXZqZ4r3Z9k8L1m5n6O7P8q9R0s1t2u3v4w5x6y7
```

---

## 🧪 Примеры запросов с curl

### Регистрация
```bash
curl -X POST http://localhost:8000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "mycompany",
    "email": "user@example.com",
    "password": "TestPass123",
    "company_name": "My Company"
  }' | jq
```

### Логин
```bash
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "TestPass123"
  }' | jq
```

### Получить профиль
```bash
TOKEN="eyJ0eXAiOiJKV1QiLCJhbGc..."

curl -X GET http://localhost:8000/api/auth/me \
  -H "Authorization: Bearer $TOKEN" | jq
```

### Логаут
```bash
curl -X POST http://localhost:8000/api/auth/logout \
  -H "Content-Type: application/json" | jq
```

---

## ⚠️ Обработка ошибок

### Email уже существует
```json
{
  "success": false,
  "message": "User with this email or username already exists",
  "data": null
}
```

### Неверные учетные данные
```json
{
  "success": false,
  "message": "Invalid email or password",
  "data": null
}
```

### Недействительный токен
```json
{
  "detail": "Invalid token"
}
```

### Токен истек
```json
{
  "detail": "Token expired"
}
```

---

## 📊 Состояния кнопок

### До логина
```
┌──────────────────┐
│  👤 Войти        │
│  (белая граница) │
└──────────────────┘
onclick → открывает login-modal
```

### После успешного логина
```
┌──────────────────────────────┐
│  👤 My Company               │
│  (зеленая кнопка)            │
└──────────────────────────────┘
onclick → logout()
```

### После логаута
```
┌──────────────────┐
│  👤 Войти        │
│  (белая граница) │
└──────────────────┘
onclick → открывает login-modal (вернулось в исходное состояние)
```

---

## 🔄 Жизненный цикл приложения

### Загрузка страницы
```
1. HTML загружается
2. script.js инициализируется
3. Проверяется localStorage.user
4. Если есть сохраненный пользователь:
   - Восстанавливается в памяти
   - updateUserUI(user) обновляет кнопку
5. Если нет - кнопка "Войти" остается в стандартном состоянии
```

### Успешный логин
```
1. Пользователь заполняет форму
2. JavaScript отправляет POST запрос
3. Backend проверяет пароль
4. Backend создает токен
5. Frontend получает ответ
6. localStorage сохраняет токен и user
7. updateUserUI() обновляет кнопку
8. Модаль закрывается
```

### Выход
```
1. Пользователь нажимает на кнопку "👤 My Company"
2. logout() удаляет localStorage данные
3. updateUserUI() возвращает кнопку в исходное состояние
4. Токен больше не отправляется в запросах
```

---

## 🎯 Итоговая цель

✅ **Полнофункциональная система авторизации:**
- Регистрация пользователей
- Логин и выход
- Сохранение сессий
- Защита паролей
- JWT токены
- Проверка администраторов

🚀 **Готово к использованию в production (с дополнительными улучшениями)**

